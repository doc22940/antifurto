<html>
    <head>
        <link rel="stylesheet" type="text/css" href="styles.css" />
        <title>Antifurto</title>
    </head>

    <body>
        <h1>Antifurto</h1>
        
        This is Antifurto by berta.

        <h2>Live view</h2>

        <div id='cmdresult'></div>
        <div>
            <img id='liveimg' src='' width=640 height=480>
        </div>

        <script type='text/javascript'>
            var numLoaders = 3;
            var delayMs = 300;
            var delayForEachMs = delayMs * numLoaders;
            var counter = 0;

            function makeLoadImage(url, imageObj, target) {
                return function() {
                    function work() {
                        imageObj.onload = function() {
                            target.setAttribute('src', this.src);
                        };
                        imageObj.src = url + '?t=' + counter++;
                    }
                    setInterval(work, delayForEachMs);
                }
            }

            function startupRequest(outDiv, onSuccess) {
                var request = new XMLHttpRequest();
                request.open('GET', 'controller/live.php', true);
                request.onload = function() {
                    response = JSON.parse(this.responseText);
                    // response is { result: int, log: string }
                    var out = document.getElementById(outDiv);
                    if (response.result == 0)
                        setTimeout(onSuccess, 3000);
                    else {
                        out.innerHTML = 'Error executing command';
                        console.log(response.log);
                    }
                }
                request.send();
            }

            startupRequest('cmdresult', function() {
                var img = document.getElementById('liveimg');
                var delay = 0;
                for (var i = 0; i < numLoaders; i++) {
                    var f = makeLoadImage('live/live' + i + '.jpg', img, new Image);
                    if (delay == 0)
                        f();
                    else
                        setTimeout(f, delay);
                    delay += delayMs;
                }
            });
        </script>

    </body>
</html>
